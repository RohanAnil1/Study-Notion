{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Instructor Dashboard</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.import_playlist') }}" class="btn btn-outline-danger">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16" style="vertical-align: -.125em;">
                    <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.01 2.01 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.01 2.01 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31 31 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.01 2.01 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A100 100 0 0 1 7.858 2zM6.4 5.209v4.818l4.157-2.408z"/>
                </svg>Import Playlist
            </a>
            <a href="{{ url_for('main.create_course') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Create New Course
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="bi bi-book-fill text-primary" style="font-size: 3rem;"></i>
                    <h3 class="fw-bold mt-3 mb-0">{{ course_stats|length }}</h3>
                    <p class="text-muted mb-0">Total Courses</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="bi bi-people-fill text-success" style="font-size: 3rem;"></i>
                    <h3 class="fw-bold mt-3 mb-0">{{ course_stats|sum(attribute='enrollments') }}</h3>
                    <p class="text-muted mb-0">Total Enrollments</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="bi bi-graph-up text-warning" style="font-size: 3rem;"></i>
                    {% set total_avg = course_stats|sum(attribute='avg_progress') %}
                    <h3 class="fw-bold mt-3 mb-0">
                        {% if course_stats|length > 0 %}
                            {{ (total_avg / course_stats|length)|round(1) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">Avg. Student Progress</p>
                </div>
            </div>
        </div>
    </div>

    <!-- My Courses Table -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0">My Courses</h4>
        <a href="{{ url_for('main.instructor_courses') }}" class="btn btn-outline-primary btn-sm">View All</a>
    </div>

    {% if course_stats %}
    <div class="table-responsive mb-5">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Course</th>
                    <th>Enrollments</th>
                    <th>Avg. Progress</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in course_stats %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if stat.course.thumbnail %}
                            <img src="{{ url_for('static', filename=stat.course.thumbnail) }}" alt="{{ stat.course.title }}"
                                class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                            {% else %}
                            <div class="bg-gradient-primary rounded me-3 d-flex align-items-center justify-content-center"
                                style="width: 60px; height: 60px;">
                                <i class="bi bi-book-fill text-white"></i>
                            </div>
                            {% endif %}
                            <div>
                                <strong>{{ stat.course.title }}</strong>
                                <br>
                                <small class="text-muted">{{ stat.course.sections.count() }} sections</small>
                            </div>
                        </div>
                    </td>
                    <td>{{ stat.enrollments }}</td>
                    <td>
                        <div class="progress" style="width: 100px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ stat.avg_progress }}%;">
                                {{ stat.avg_progress|round(1) }}%
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if stat.course.is_published %}
                        <span class="badge bg-success">Published</span>
                        {% else %}
                        <span class="badge bg-secondary">Draft</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('main.edit_course', course_id=stat.course.id) }}" class="btn btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{{ url_for('main.course_details', course_id=stat.course.id) }}" class="btn btn-outline-info" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            <form method="POST" action="{{ url_for('main.delete_course', course_id=stat.course.id) }}"
                                style="display: inline;"
                                onsubmit="return confirm('Are you sure you want to delete this course?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5 mb-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <p class="text-muted mt-3">You haven't created any courses yet.</p>
        <a href="{{ url_for('main.create_course') }}" class="btn btn-primary mt-2">
            <i class="bi bi-plus-circle me-2"></i>Create Your First Course
        </a>
    </div>
    {% endif %}

    <!-- Recent Media -->
    {% if recent_media %}
    <h4 class="fw-bold mb-3">Recent Media</h4>
    <div class="row g-3">
        {% for media in recent_media %}
        <div class="col-md-2">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center p-3">
                    {% if media.file_type == 'image' %}
                    <i class="bi bi-image text-primary" style="font-size: 2rem;"></i>
                    {% else %}
                    <i class="bi bi-file-earmark text-secondary" style="font-size: 2rem;"></i>
                    {% endif %}
                    <p class="small text-muted text-truncate mt-2 mb-0" title="{{ media.filename }}">{{ media.filename }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
